<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mall Nusantara - Panel Admin</title>
  <style>
    body {
      font-size: 12px;
      margin: 0;
      font-family: Poppins, Arial;
      background: #f5f7fb;
      color: #333;
      padding-bottom: 70px; /* Memberi ruang agar konten tidak tertutup tombol logout */
    }
    header {
      background: #007bff;
      color: #fff;
      padding: 6px;
      text-align: center;
    }
    .tanggal {
      font-size: 10px;
      color: #eaf3ff;
      margin-top: 12px;
    }
    main {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 10px 10px;
    }
    .section {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 12px;
    }
    h2 {
      font-size: 14px;
      margin: 0;
      color: #007bff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    th, td {
      padding: 8px;
      border: 2px solid #e6ebf5;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #f1f7ff;
    }
    .actions {
      display: flex;
      gap: 6px;
      justify-content: center;
    }
    button.action {
      padding: 6px;
      border: 0;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-panggil { background: #0069d9; }
    .btn-selesai { background: #28a745; }
    .btn-hapus { background: #dc3545; }
    .empty {
      color: #888;
      font-style: italic;
    }

    /* Tombol Logout Baru ‚Äî Full-width di bawah */
    #logoutBtn {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 12px;
      background: #007bff; /* Warna biru utama */
      color: white;
      border: none;
      font-size: 14px;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.15);
      z-index: 1000;
    }

    @media (max-width: 480px) {
      .actions {
        flex-direction: row;
      }
      button.action {
        padding: 6px 8px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Antrian Mall Nusantara</h1>
    <div class="tanggal" id="tanggal"></div>
  </header>

  <main>
    <div class="section">
      <h2>Lobby Aktif (Veteran)</h2>
      <table id="aktif-table">
        <thead><tr><th>No</th><th>No Polisi</th><th>Status</th><th>Aksi</th></tr></thead>
        <tbody><tr><td colspan="4" class="empty">Belum ada data</td></tr></tbody>
      </table>
    </div>
    <div class="section">
      <h2>Buffer (Menunggu)</h2>
      <table id="buffer-table">
        <thead><tr><th>No</th><th>No Polisi</th><th>Status</th><th>Aksi</th></tr></thead>
        <tbody><tr><td colspan="4" class="empty">Belum ada data</td></tr></tbody>
      </table>
    </div>
  </main>

  <!-- Tombol Logout di paling bawah -->
  <button id="logoutBtn">Logout</button>

  <script type="module">
    // Perbaiki: hapus spasi di akhir URL import
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js';
    import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js';
    import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCZ-hruI3CTyKeBtqqmNoIBFNBPw1h6Sbo",
      authDomain: "poi-sistem.firebaseapp.com",
      projectId: "poi-sistem",
      storageBucket: "poi-sistem.appspot.com",
      messagingSenderId: "952727715423",
      appId: "1:952727715423:web:438bdb765c8864c9e2e5ea",
      databaseURL: "https://poi-sistem-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const lokasi = 'mall_nusantara';

    function updateTanggal() {
      const t = new Date();
      const hari = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
      document.getElementById('tanggal').innerText = `${hari[t.getDay()]}, ${t.getDate()}-${t.getMonth()+1}-${t.getFullYear()}`;
    }
    updateTanggal();

    onAuthStateChanged(auth, user => {
      if (!user) location.href = '/login.html';
    });

    function setEmpty(tableId) {
      document.querySelector(`#${tableId} tbody`).innerHTML = '<tr><td colspan="4" class="empty">Belum ada data</td></tr>';
    }

    function renderRows(tableId, items) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = '';
      if (!items.length) {
        setEmpty(tableId);
        return;
      }
      items.forEach((item, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${item.noPol}</td>
          <td>${item.status}</td>
          <td>
            <div class="actions">
              <button class="action btn-panggil" data-nopol="${item.noPol}">üì£</button>
              <button class="action btn-selesai" data-nopol="${item.noPol}">‚úÖ</button>
              <button class="action btn-hapus" data-nopol="${item.noPol}">üóëÔ∏è</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
      attachButtons();
    }

    onValue(ref(db, `pangkalan/${lokasi}/antrian`), snap => {
      const data = snap.val() || {};
      const arr = Object.values(data).map(d => ({ ...d }));
      arr.sort((a, b) => (a.createdAt || '') > (b.createdAt || '') ? 1 : -1);
      const aktif = arr.filter(x => x.status === 'aktif');
      const buffer = arr.filter(x => x.status === 'buffer');
      renderRows('aktif-table', aktif);
      renderRows('buffer-table', buffer);
    });

    function attachButtons() {
      document.querySelectorAll('.btn-hapus').forEach(btn => {
        btn.onclick = async () => {
          const noPol = btn.dataset.nopol;
          if (!confirm(`Hapus ${noPol}?`)) return;
          await fetch(`/api/handler?action=hapus&lokasi=${lokasi}&noPol=${encodeURIComponent(noPol)}`);
        };
      });

      document.querySelectorAll('.btn-selesai').forEach(btn => {
        btn.onclick = async () => {
          const noPol = btn.dataset.nopol;
          await fetch(`/api/handler?action=selesai&lokasi=${lokasi}&noPol=${encodeURIComponent(noPol)}`);
        };
      });

      document.querySelectorAll('.btn-panggil').forEach(btn => {
        btn.onclick = async () => {
          const noPol = btn.dataset.nopol;
          const res = await fetch(`/api/handler?action=panggil&lokasi=${lokasi}&noPol=${encodeURIComponent(noPol)}`);
          if (!res.ok) alert('Gagal panggil WA');
        };
      });
    }

    document.getElementById('logoutBtn').onclick = () => {
      signOut(auth).then(() => {
        location.href = '/login.html';
      });
    };
  </script>
</body>
  </html>
